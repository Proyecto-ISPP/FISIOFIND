name: Generate Changelog

on:
  push:
    branches:
      - develop
      - main
      - feat/changelog.yml

jobs:
  generate_changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'

      - name: Get latest tag
        id: get-latest-tag
        run: |
          latest_tag=$(git tag --sort=-v:refname | head -n 1)
          echo "Latest tag: $latest_tag"

          if [[ -z "$latest_tag" ]]; then
            new_tag="1.0.0"
          else
            major=$(echo "$latest_tag" | cut -d. -f1)
            new_major=$((major + 1))
            new_tag="${new_major}.0.0"
          fi

          echo "New tag will be: $new_tag"
          echo "NEW_TAG=$new_tag" >> $GITHUB_ENV

      - name: Debug NEW_TAG
        run: echo "NEW_TAG is $NEW_TAG"

      - name: Generate changelog
        id: generate-changelog
        env:
          NEW_TAG: ${{ env.NEW_TAG }}
        run: |
          echo "## ðŸš€ Changelog - $NEW_TAG" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          git log --pretty=format:"%s (@%an)" $(git describe --tags --abbrev=0)..HEAD |
          grep -vE "Merge (pull request|branch)" |
          sort -u |
          awk '
            BEGIN {
              features = ""
              fixes = ""
              docs = ""
              others = ""
            }

            /^feat:/ {
              features = features "- " $0 "\n"
              next
            }

            /^fix:/ {
              fixes = fixes "- " $0 "\n"
              next
            }

            /^docs?:/ {
              docs = docs "- " $0 "\n"
              next
            }

            {
              others = others "- " $0 "\n"
            }

            END {
              if (features != "") {
                print "### âœ¨ Features\n" features
              }
              if (fixes != "") {
                print "### ðŸ› Fixes\n" fixes
              }
              if (docs != "") {
                print "### ðŸ“– Documentation\n" docs
              }
              if (others != "") {
                print "### ðŸ“¦ Others\n" others
              }
            }
          ' >> CHANGELOG.md

      - name: Commit and push changelog
        run: |
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG for $NEW_TAG"
          git push
